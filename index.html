<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>忍術性質変化バトル Ver.60</title>
<link href="https://fonts.googleapis.com/css2?family=Reggae+One&display=swap" rel="stylesheet">
<style>
    :root { --p1-color: #ff4500; --p2-color: #00bfff; --gold: #ffd700; --silver: #c0c0c0; --dark-bg: #111; }
    body { font-family: 'Reggae One', serif; text-align: center; background-color: var(--dark-bg); color: #fff; margin: 0; overflow: hidden; height: 100dvh; display: flex; flex-direction: column; user-select: none; -webkit-tap-highlight-color: transparent; }

    /* 背景 */
    #bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; transition: background 0.5s; }
    .bg-normal { background: radial-gradient(circle at center, #222 0%, #000 100%); }
    .bg-leaf { background: radial-gradient(circle at center, #1e3c00 0%, #0a1400 100%); }
    .bg-valley { background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); }
    .bg-tsuku { background: radial-gradient(circle, #500000 0%, #000 100%); }
    .bg-war { background: linear-gradient(to bottom, #3e3e3e, #5a4a3a); }
    .particle { position: absolute; border-radius: 50%; opacity: 0.6; animation: float-up linear infinite; pointer-events: none; }
    @keyframes float-up { 0% { transform: translateY(100vh); opacity: 0; } 50% { opacity: 0.8; } 100% { transform: translateY(-10vh); opacity: 0; } }

    /* UI共通 */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 4000; display: none; flex-direction: column; align-items: center; justify-content: center; }
    .modal-content { width: 90%; max-width: 400px; max-height: 80%; overflow-y: auto; text-align: center; }
    
    /* タイトル */
    #title-screen { z-index: 3000; display: flex; }
    .main-logo { font-size: 3.5rem; color: var(--gold); text-shadow: 0 0 10px #ff8c00; margin-bottom: 20px; }
    
    #player-status-box { width: 85%; max-width: 350px; border: 1px solid var(--gold); margin-bottom: 30px; padding: 15px; background: rgba(0,0,0,0.6); cursor: pointer; border-radius: 8px; }
    .status-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 1.2rem; }
    .exp-bar { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; }
    .exp-fill { height: 100%; background: linear-gradient(90deg, #ff8c00, var(--gold)); width: 0%; }

    /* ボタン */
    .btn-lg { width: 280px; padding: 20px; font-size: 1.5rem; background: var(--gold); color: #000; border: none; border-radius: 50px; cursor: pointer; font-family: 'Reggae One'; margin: 10px 0; box-shadow: 0 4px 15px rgba(255,215,0,0.4); }
    .btn-lg:active { transform: scale(0.95); }
    .btn-md { width: 240px; padding: 15px; font-size: 1.2rem; background: #333; color: #fff; border: 1px solid #666; border-radius: 30px; cursor: pointer; font-family: 'Reggae One'; margin: 8px 0; }
    .btn-sm { padding: 10px 20px; background: #444; color: #fff; border: 1px solid #fff; border-radius: 5px; cursor: pointer; font-family: 'Reggae One'; }

    /* クエスト */
    .quest-item { background: #222; border: 1px solid #444; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; cursor: pointer; }
    .quest-item:hover { border-color: var(--gold); }
    .quest-item.locked { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
    .quest-rank { font-size: 1.5rem; font-weight: bold; width: 50px; margin-right: 15px; }

    /* ゲーム画面 */
    .player-area { height: 35%; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; position: relative; }
    #p2-area { transform: rotate(180deg); }
    .hand { display: flex; justify-content: center; gap: 8px; min-height: 110px; width: 100%; align-items: flex-end; }

    /* カード */
    .card { width: 75px; height: 110px; border-radius: 6px; background: #000; border: 2px solid #555; position: relative; transition: transform 0.2s; }
    .card img { width: 100%; height: 100%; object-fit: cover; opacity: 1; display: block; }
    .card-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.8); font-size: 12px; padding: 2px 0; }
    .card.selected { transform: translateY(-20px); border-color: var(--gold); box-shadow: 0 0 15px var(--gold); z-index: 100; }

    .card.rank-silver { border-color: #ccc; box-shadow: 0 0 8px #ccc; }
    .card.rank-rainbow { border-color: #fff; animation: border-rain 2s linear infinite; }
    @keyframes border-rain { 0%{ box-shadow: 0 0 8px red; border-color: red; } 50%{ box-shadow: 0 0 8px cyan; border-color: cyan; } 100%{ box-shadow: 0 0 8px magenta; border-color: magenta; } }

    /* 決定ボタン */
    .decide-btn { width: 180px; height: 55px; background: #a00; border: 2px solid #ffcc00; border-radius: 30px; font-size: 1.4rem; font-family: 'Reggae One'; color: #fff; pointer-events: auto; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .decide-btn:active { transform: scale(0.95); }

    /* バトル中央 */
    #battle-center { z-index: 50; height: 30%; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
    #score-display { font-size: 2.5rem; text-shadow: 0 0 10px #000; margin-bottom: 10px; }
    #status-msg { font-size: 1.2rem; color: #aaa; }

    /* 演出 (ズームなし) */
    #anim-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000; }
    .clash-card { position: absolute; width: 75px; height: 110px; background: #000; border: 2px solid #fff; border-radius: 6px; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; }
    .clash-card img { width: 100%; height: 100%; object-fit: cover; }

    /* アニメーション */
    @keyframes move-p1 { 0%{transform:translate(-50%, 50vh);} 100%{transform:translate(-50%, 10px);} }
    @keyframes move-p2 { 0%{transform:translate(-50%, -50vh) rotate(180deg);} 100%{transform:translate(-50%, -110px) rotate(180deg);} }
    
    #result-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 5rem; text-shadow: 0 0 20px #000; opacity: 0; z-index: 2500; white-space: nowrap; }
    
    /* カットイン */
    #cutin-overlay { position: fixed; top: 40%; left: 0; width: 100%; height: 20%; display: flex; align-items: center; justify-content: center; z-index: 2500; pointer-events: none; opacity: 0; }
    .cutin-bg { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.8); border-top: 2px solid #fff; border-bottom: 2px solid #fff; transform: scaleX(0); transition: transform 0.2s; }
    .cutin-text { font-size: 4rem; color: #fff; font-weight: bold; font-style: italic; z-index: 2; transform: translateX(100px); opacity: 0; transition: 0.3s; }

</style>
</head>
<body>

<div id="bg-container" class="bg-normal"></div>

<div id="title-screen" class="modal" style="display:flex;">
    <div class="main-logo">忍術<br>性質変化</div>
    <div id="player-status-box">
        <div class="status-row"><span id="rank-val">アカデミー生</span><span id="level-val">Lv.1</span></div>
        <div class="exp-bar"><div class="exp-fill" id="title-exp-bar"></div></div>
        <div style="font-size:0.8rem; text-align:right; color:#ccc" id="title-exp-text">0 / 100</div>
    </div>
    <button class="btn-lg" onclick="openQuest()">任務開始</button>
    <button class="btn-md" onclick="openPvP()">対人演習</button>
    <button class="btn-md" onclick="openSettings()">環境設定</button>
</div>

<div id="quest-modal" class="modal">
    <div style="font-size:2rem; color:var(--gold); margin-bottom:20px;">任務一覧</div>
    <div class="modal-content" id="quest-list"></div>
    <button class="btn-md" onclick="closeModal('quest-modal')">戻る</button>
</div>

<div id="briefing-modal" class="modal">
    <div style="background:#222; padding:30px; border-radius:10px; border:2px solid var(--gold); width:80%; max-width:350px;">
        <h2 style="color:var(--gold); margin:0 0 20px 0;">作戦会議</h2>
        <p id="briefing-target" style="font-size:1.5rem; margin-bottom:30px;">VS 敵</p>
        <button class="btn-lg" style="font-size:1.2rem; padding:15px;" onclick="startGame('N')">通常作戦<br><span style="font-size:0.8rem">(3戦勝負 / 手札減らない)</span></button>
        <button class="btn-lg" style="font-size:1.2rem; padding:15px; margin-top:10px; background:#555; color:#fff;" onclick="startGame('A')">上級作戦<br><span style="font-size:0.8rem">(5戦勝負 / 手札消費)</span></button>
        <button class="btn-sm" style="margin-top:20px;" onclick="closeModal('briefing-modal')">中止</button>
    </div>
</div>

<div id="settings-modal" class="modal">
    <h2>環境設定</h2>
    <p>カード演出</p>
    <div style="display:flex; gap:10px; justify-content:center; margin-bottom:30px;">
        <button class="btn-sm" onclick="setEffect('none')">通常</button>
        <button class="btn-sm" onclick="setEffect('silver')">銀(Lv15)</button>
        <button class="btn-sm" onclick="setEffect('rainbow')">虹(Lv50)</button>
    </div>
    <button class="btn-md" onclick="closeModal('settings-modal')">閉じる</button>
</div>

<div id="result-modal" class="modal">
    <h1 id="res-title" style="font-size:4rem; color:var(--gold);">勝利</h1>
    <p id="res-reason" style="font-size:1.5rem;">理由</p>
    <div style="margin:30px 0;">
        <p>経験値 +<span id="res-exp">0</span></p>
        <div class="exp-bar" style="width:200px; margin:0 auto;"><div class="exp-fill" id="res-bar"></div></div>
    </div>
    <button class="btn-lg" onclick="location.reload()">タイトルへ</button>
</div>

<div id="cutin-overlay">
    <div class="cutin-bg"></div>
    <div class="cutin-text" id="cutin-text">火遁</div>
</div>

<div id="anim-layer"></div>
<div id="result-text"></div>

<div id="p2-area" class="player-area">
    <div style="color:#aaa; margin-bottom:5px;" id="enemy-name">CPU</div>
    <div id="p2-hand" class="hand"></div>
    <button id="p2-btn" class="decide-btn" onclick="decide(2)">P2 決定</button>
</div>

<div id="battle-center">
    <div id="score-display"><span style="color:var(--p1-color)">0</span> - <span style="color:var(--p2-color)">0</span></div>
    <div id="status-msg">第 1 戦目</div>
</div>

<div id="p1-area" class="player-area">
    <button id="p1-btn" class="decide-btn" onclick="decide(1)">P1 決定</button>
    <div id="p1-hand" class="hand"></div>
</div>

<script>
// 画像
const icons = { '火':'https://livedoor.blogimg.jp/pokeruto_narutostorm/imgs/9/d/9df794cc.png', '水':'https://ooyake01.com/wp-content/uploads/2019/07/%E6%89%89%E9%96%93.png', '土':'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQgUZKzoGoqlDT7mUC9X8fE76pwS8yTZOsQJWSf0JLyzQ&s', '風':'https://otakotaku.com/asset/img/character/2017/10/uzumaki-naruto-59dbafb3a0d9ep.jpg', '雷':'https://images-na.ssl-images-amazon.com/images/I/71rse6gO0XL._CR550,250,1420,1420_.jpg' };
const typeOrd={'火':1,'水':2,'土':3,'風':4,'雷':5}, types=['火','水','土','風','雷'];
const rel={'火':'風','風':'雷','雷':'土','土':'水','水':'火'};

// クエスト
const QUESTS = [
    {id:1, rank:'D', title:'カカシ先生', ai:1, bg:'bg-leaf'}, {id:2, rank:'D', title:'ミズキ', ai:1, bg:'bg-leaf'}, {id:3, rank:'D', title:'再不斬', ai:1, bg:'bg-valley'},
    {id:4, rank:'C', title:'大蛇丸(偽)', ai:2, bg:'bg-leaf'}, {id:5, rank:'C', title:'我愛羅', ai:2, bg:'bg-normal'},
    {id:6, rank:'B', title:'君麻呂', ai:2, bg:'bg-leaf'}, {id:7, rank:'B', title:'サスケ(呪印)', ai:2, bg:'bg-valley'},
    {id:8, rank:'A', title:'イタチ', ai:3, bg:'bg-tsuku'}, {id:9, rank:'A', title:'ペイン', ai:3, bg:'bg-leaf'},
    {id:10, rank:'S', title:'マダラ', ai:3, bg:'bg-war'}, {id:11, rank:'S', title:'カグヤ', ai:3, bg:'bg-war'}
];

// 変数
let pData = { lv:1, exp:0, quest:0, eff:'none', wins:0 };
let currentQ = null, hands, scores, selected, confirmed, turn, gMode='N', pMode='C', p1D=[], p2D=[], firstWin=0, bannedStr=null;

// 初期化
window.onload = function() {
    const d=localStorage.getItem('NB_V60');
    if(d) pData = JSON.parse(d);
    updateStatus();
    initParticles();
};
function save() { localStorage.setItem('NB_V60', JSON.stringify(pData)); }
function getNextExp() { return pData.lv * 100; }

function updateStatus() {
    let r = "アカデミー生";
    if(pData.lv>=5) r="下忍"; if(pData.lv>=15) r="中忍"; if(pData.lv>=30) r="上忍"; if(pData.lv>=50) r="影";
    document.getElementById('rank-val').innerText = r;
    document.getElementById('level-val').innerText = "Lv." + pData.lv;
    const pct = (pData.exp / getNextExp()) * 100;
    document.getElementById('title-exp-bar').style.width = pct + "%";
    document.getElementById('title-exp-text').innerText = pData.exp + " / " + getNextExp();
}

// UI
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
function setEffect(e) { pData.eff = e; save(); alert("設定しました"); }

function openQuest() {
    const list = document.getElementById('quest-list'); list.innerHTML = "";
    QUESTS.forEach((q, i) => {
        const div = document.createElement('div');
        const unlocked = i <= pData.quest;
        div.className = 'quest-item ' + (unlocked ? '' : 'locked');
        div.innerHTML = `<div class="quest-rank" style="color:${getRankColor(q.rank)}">${q.rank}</div><div>${q.title}</div>`;
        div.onclick = () => { if(unlocked) showBriefing(q); };
        list.appendChild(div);
    });
    document.getElementById('quest-modal').style.display = 'flex';
}
function getRankColor(r) { return r==='S'?'#ffd700':(r==='A'?'#ff4500':(r==='B'?'#00bfff':'#fff')); }

function showBriefing(q) {
    currentQ = q;
    document.getElementById('briefing-target').innerText = "VS " + q.title;
    document.getElementById('briefing-modal').style.display = 'flex';
}
function openPvP() {
    currentQ = null;
    document.getElementById('briefing-target').innerText = "対人演習";
    document.getElementById('briefing-modal').style.display = 'flex';
}

function startGame(mode) {
    gMode = mode;
    pMode = currentQ ? 'C' : 'P';
    closeModal('briefing-modal');
    closeModal('quest-modal');
    document.getElementById('title-screen').style.display = 'none';
    
    const bg = document.getElementById('bg-container');
    bg.className = currentQ ? currentQ.bg : 'bg-normal';
    document.getElementById('enemy-name').innerText = currentQ ? currentQ.title : 'Player 2';
    
    initBattle();
}

function initBattle() {
    hands = {1:[...types], 2:[...types]};
    scores = {1:0, 2:0};
    selected = {1:[], 2:[]};
    confirmed = {1:false, 2:false};
    turn = 1; firstWin = 0; p1D = []; p2D = []; bannedStr = null;
    document.getElementById('p2-btn').style.visibility = (pMode==='C') ? 'hidden' : 'visible';
    updateInfo(); renderHands(); unlockUI();
}

function updateInfo() {
    document.getElementById('score-display').innerHTML = `<span style="color:var(--p1-color)">${scores[1]}</span> - <span style="color:var(--p2-color)">${scores[2]}</span>`;
    document.getElementById('status-msg').innerText = `第 ${turn} 戦目`;
}

function renderHands() {
    const cls = (pData.eff==='rainbow')?'rank-rainbow':(pData.eff==='silver'?'rank-silver':'');
    for(let p=1; p<=2; p++) {
        const div = document.getElementById(`p${p}-hand`); div.innerHTML = "";
        hands[p].forEach(type => {
            const d = document.createElement('div');
            const isSel = selected[p].includes(type);
            d.className = `card ${cls} ${isSel?'selected':''}`;
            d.innerHTML = `<img src="${icons[type]}"><div class="card-label">${type}</div>`;
            d.onclick = () => { if(!confirmed[p]) toggleSelect(p, type); };
            div.appendChild(d);
        });
    }
}

function toggleSelect(p, type) {
    if(selected[p].includes(type)) selected[p] = selected[p].filter(t => t!==type);
    else selected[p].push(type);
    renderHands();
}

function decide(p) {
    const s = selected[p].sort((a,b)=>typeOrd[a]-typeOrd[b]);
    const combo = s.join("+");
    if(s.length===0) return;
    if(s.length===2 && !(s.includes('水') && s.includes('風'))) { alert("2枚出しは氷遁(水+風)のみ"); return; }
    if(s.length===3 && !(s.includes('火') && s.includes('風') && s.includes('土'))) { alert("3枚出しは塵遁(火+風+土)のみ"); return; }
    if(s.length>3) return;
    if(combo === bannedStr) { alert("その手は封印されています"); return; }

    if(p===1) p1D = s; else p2D = s;
    confirmed[p] = true; selected[p] = [];
    renderHands();
    
    document.getElementById(`p${p}-area`).style.opacity = 0.5;
    document.getElementById(`p${p}-btn`).style.pointerEvents = 'none';

    if(confirmed[1]) {
        if(pMode === 'C') setTimeout(runAI, 500);
        else if(confirmed[2]) setTimeout(runAnim, 500);
    }
}

function runAI() {
    const h2 = hands[2];
    let moves = [];
    h2.forEach(c => moves.push([c]));
    if(h2.includes('水') && h2.includes('風')) moves.push(['水','風']);
    if(h2.includes('火') && h2.includes('風') && h2.includes('土')) moves.push(['火','風','土']);
    
    if(bannedStr) moves = moves.filter(m => m.join("+") !== bannedStr);

    const aiLvl = currentQ ? currentQ.ai : 1;
    let myMove = moves[Math.floor(Math.random()*moves.length)];
    
    if(aiLvl >= 2) {
        const counters = moves.filter(m => getResult(m, p1D) === 2); 
        if(counters.length > 0 && (aiLvl===3 || Math.random()>0.5)) myMove = counters[0];
    }
    p2D = myMove;
    confirmed[2] = true;
    setTimeout(runAnim, 500);
}

function getResult(h1, h2) {
    if(h1.length > h2.length) return 1;
    if(h2.length > h1.length) return 2;
    if(h1.length === 1) {
        const t1 = h1[0], t2 = h2[0];
        if(rel[t1] === t2) return 1;
        if(rel[t2] === t1) return 2;
    }
    return 0; 
}

function runAnim() {
    let name = p1D.length===3?"塵遁":(p1D.length===2?"氷遁":p1D[0]+"遁");
    const cutBg = document.querySelector('.cutin-bg');
    const cutTx = document.querySelector('.cutin-text');
    document.getElementById('cutin-overlay').style.opacity = 1;
    cutTx.innerText = name;
    
    cutBg.style.transform = "scaleX(1)";
    setTimeout(() => { cutTx.style.opacity=1; cutTx.style.transform="translateX(0)"; }, 200);
    
    setTimeout(() => {
        document.getElementById('cutin-overlay').style.opacity = 0;
        cutBg.style.transform = "scaleX(0)"; cutTx.style.opacity=0;
        const layer = document.getElementById('anim-layer'); layer.innerHTML = "";
        createClashCard(p1D, 'p1', layer); createClashCard(p2D, 'p2', layer);
        setTimeout(resolve, 1000);
    }, 1500);
}

function createClashCard(arr, owner, parent) {
    const div = document.createElement('div');
    div.className = 'clash-card';
    div.innerHTML = `<img src="${icons[arr[0]]}">`;
    div.style.borderColor = (owner==='p1') ? 'var(--p1-color)' : 'var(--p2-color)';
    div.style.animation = (owner==='p1') ? 'move-p1 0.5s forwards' : 'move-p2 0.5s forwards';
    div.style.opacity = 1;
    parent.appendChild(div);
}

function resolve() {
    const res = getResult(p1D, p2D);
    const txt = document.getElementById('result-text');
    const s1 = p1D.join("+"), s2 = p2D.join("+");
    const isSameHand = (s1 === s2); // 完全一致かどうか

    let msg = "";
    if(res === 1) { msg="勝利"; txt.style.color="var(--p1-color)"; }
    else if(res === 2) { msg="敗北"; txt.style.color="var(--p2-color)"; }
    else { msg="あいこ"; txt.style.color="#fff"; }
    
    txt.innerText = msg; txt.style.opacity = 1;
    
    setTimeout(() => {
        txt.style.opacity = 0;
        document.getElementById('anim-layer').innerHTML = "";
        
        if(res === 1) { scores[1]++; if(firstWin===0) firstWin=1; consume(); }
        else if(res === 2) { scores[2]++; if(firstWin===0) firstWin=2; consume(); }
        else {
            // あいこの処理
            if(isSameHand) {
                // 同じ手 (例: 火 vs 火) -> 出し直し (ノーマル)
                if(gMode === 'N') {
                    if(turn === 3) { checkGameEnd(); } // 3戦目なら終了
                    else { alert("同じ手のため、出し直し！"); unlockUI(); } // 消費せず再開
                } else {
                    // アドバンス: 封印して次へ
                    if(turn === 1) bannedStr = s1;
                    consume();
                }
            } else {
                // 違う手で引き分け (例: 火 vs 雷) -> そのまま次へ
                consume();
            }
        }
    }, 2000);
}

function consume() {
    p1D.forEach(c => hands[1].splice(hands[1].indexOf(c), 1));
    p2D.forEach(c => hands[2].splice(hands[2].indexOf(c), 1));
    turn++;
    updateInfo();
    checkGameEnd();
}

function checkGameEnd() {
    let isEnd = false;
    if(scores[1] >= 2 || scores[2] >= 2) isEnd = true;
    else if(gMode === 'N' && turn > 3) isEnd = true;
    else if(gMode === 'A' && (turn > 5 || hands[1].length === 0 || hands[2].length === 0)) isEnd = true;
    else if(hands[1].length === 0) isEnd = true;
    
    if(isEnd) finishGame(); else unlockUI();
}

function unlockUI() {
    confirmed[1] = false; confirmed[2] = false;
    p1D = []; p2D = []; selected[1] = []; selected[2] = [];
    document.getElementById('p1-area').style.opacity = 1;
    document.getElementById('p1-btn').style.pointerEvents = 'auto';
    document.getElementById('p2-area').style.opacity = 1;
    if(pMode === 'P') document.getElementById('p2-btn').style.pointerEvents = 'auto';
    renderHands();
}

function finishGame() {
    let w = 0;
    if(scores[1] > scores[2]) w = 1;
    else if(scores[2] > scores[1]) w = 2;
    else {
        if(hands[1].length > hands[2].length) w = 1;
        else if(hands[2].length > hands[1].length) w = 2;
        else if(firstWin === 1) w = 1;
        else if(firstWin === 2) w = 2;
    }
    
    let exp = (w===1) ? 50 : 15;
    if(w===1 && currentQ) exp += 20;
    pData.exp += exp;
    while(pData.exp >= getNextExp()) { pData.exp -= getNextExp(); pData.lv++; }
    if(w===1) { pData.wins++; if(currentQ && currentQ.id === pData.quest + 1) pData.quest++; }
    save();

    document.getElementById('res-title').innerText = (w===1)?"勝利":(w===2?"敗北":"引分");
    document.getElementById('res-reason').innerText = `壱:${scores[1]} - 弐:${scores[2]}`;
    document.getElementById('res-exp').innerText = exp;
    const pct = (pData.exp / getNextExp()) * 100;
    document.getElementById('res-bar').style.width = pct + "%";
    document.getElementById('result-modal').style.display = 'flex';
}

function initParticles(){
    const bg=document.getElementById('bg-container');
    for(let i=0;i<30;i++){const p=document.createElement('div');p.className='particle';const s=Math.random()*5+2;p.style.width=s+'px';p.style.height=s+'px';p.style.background=(Math.random()>0.5)?'#ff4500':'#00bfff';p.style.left=Math.random()*100+'%';p.style.animationDuration=(Math.random()*10+5)+'s';p.style.animationDelay=Math.random()*5+'s';bg.appendChild(p);}
}
</script>
</body>
</html>
